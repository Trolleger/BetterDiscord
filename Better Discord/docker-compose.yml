version: '3.8'

services:
  cockroachdb:
    container_name: cockroachdb
    image: cockroachdb/cockroach:v22.2.8
    hostname: cockroachdb
    ports:
      - "26257:26257"
      - "8080:8080"
    command: 
      - start-single-node
      - --insecure
      - --listen-addr=0.0.0.0
      - --http-addr=0.0.0.0
      - --advertise-addr=cockroachdb
    environment:
      COCKROACH_ALLOW_INTERNET_ACCESS: "true"
      COCKROACH_UI_RELEASE_NOTES_OPT_OUT: "true"
    volumes:
      - cockroach-data:/cockroach/cockroach-data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health?ready=1 || exit 1"]
      interval: 10s
      timeout: 30s
      retries: 30
    networks:
      betterdiscord:
        aliases:
          - db

  backend:
    build:
      context: ./backend/chat_app
    environment:
      DATABASE_URL: "postgresql://root@cockroachdb:26257/chat_app_dev?sslmode=disable"
      ECTO_IPV6: "true"
      ERL_AFLAGS: "-proto_dist inet6_tcp"
    ports:
      - "4000:4000"
    networks:
      - betterdiscord
    depends_on:
      cockroachdb:
        condition: service_healthy

  coturn:
    image: instrumentisto/coturn:4.5.2
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
    volumes:
      - ./backend/chat_app/secrets:/run/secrets:ro
    networks:
      - betterdiscord

  janus:
    image: canyan/janus-gateway:latest
    ports:
      - "8088:8088"
      - "8188:8188"
    volumes:
      - janus-config:/usr/local/etc/janus
    networks:
      - betterdiscord
    depends_on:
      - coturn

  minio:
    image: minio/minio:RELEASE.2023-10-25T06-33-25Z
    command: server /data --console-address ":9001"
    ports:
      - "9002:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    networks:
      - betterdiscord

  frontend:
    build:
      context: ./frontend
    ports:
      - "80:80"
    networks:
      - betterdiscord
    depends_on:
      - backend

volumes:
  cockroach-data:
    driver: local
  janus-config:
    driver: local
  minio-data:
    driver: local

networks:
  betterdiscord:
    driver: bridge
    attachable: true
    ipam:
      config:
        - subnet: 172.28.0.0/16  # Changed to rarely-used range
          gateway: 172.28.0.1
        - subnet: fd00:dba::/64   # Unique IPv6 range