# TODO: Update to OTP-28 in the future after fixing ArgumentError on escaping references (written 2025-07-06)
FROM elixir:1.18.0-otp-27-alpine

# Install build tools, git, Node.js, PostgreSQL client, and inotify-tools for development
RUN apk add --no-cache build-base git nodejs npm postgresql-client inotify-tools

# Create user with matching UID and GID passed as build args (default 1000)
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN addgroup -g ${GROUP_ID} appuser && \
    adduser -D -u ${USER_ID} -G appuser appuser

WORKDIR /app
RUN chown -R appuser:appuser /app

USER appuser

# Install Hex and Rebar locally as appuser
RUN mix local.hex --force && mix local.rebar --force

# Copy mix config files and install deps as appuser
COPY --chown=appuser:appuser mix.exs mix.lock ./
RUN mix deps.get && mix deps.compile

# Copy the rest of your app code as appuser
COPY --chown=appuser:appuser . .

EXPOSE 4000

CMD ["mix", "phx.server"]
